// This is Prisma schema file, learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

// ===================
// Session
// ===================
model Session {
  id           String    @id @default(cuid())
  refreshToken String?   @unique
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  expiresAt    DateTime?
  revokedAt    DateTime?
  ipAddress    String?
  userAgent    String?
  deviceName   String?

  // Required relationship to User
  userId String // Foreign key to User model
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([id, userId])
}

// ===================
// User 
// ===================
model User {
  id                              String    @id @default(cuid())
  email                           String    @unique
  password                        String
  name                            String? // TODO: Remove this field in favor of UserProfile's firstName and lastName
  createdAt                       DateTime  @default(now())
  updatedAt                       DateTime  @updatedAt
  emailVerified                   Boolean   @default(false)
  emailVerificationToken          String?   @unique
  emailVerificationTokenExpiresAt DateTime?

  // Relations
  sessions      Session[]
  tasks         Task[]
  projects      Project[]
  userSettings  UserSettings?
  userProfile   UserProfile?
  tags          Tag[]
  notifications Notification[]
}

// ===================
// Task
// ===================
model Task {
  id             String             @id @default(cuid())
  title          String
  description    String?
  status         TaskStatus         @default(PENDING)
  priority       TaskPriority       @default(MEDIUM)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  deletedAt      DateTime?
  dueDate        DateTime?
  remindAt       DateTime?
  reminderStatus TaskReminderStatus @default(CANCELED)
  metadata       Json?
  // Required relationship to User
  userId         String
  user           User               @relation(fields: [userId], references: [id])
  // Optional relationship to Project
  projectId      String?
  project        Project?           @relation(fields: [projectId], references: [id])

  // Many-to-many relationship with Tag through TaskTag
  tags TaskTag[]

  @@index([id, userId])
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELED
  OVERDUE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

enum TaskReminderStatus {
  PENDING
  SENT
  CANCELED
}

// ===================
// Project
// ===================
model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  metadata    Json?
  // Required relationship to User
  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id])
  // One-to-many relationship with Task
  tasks       Task[]
}

// ===================
// User Settings
// ===================
model UserSettings {
  id                        String          @id @default(cuid())
  theme                     ThemePreference @default(SYSTEM)
  notificationsEnabled      Boolean         @default(true)
  emailNotificationsEnabled Boolean         @default(true)
  pushNotificationsEnabled  Boolean         @default(true)
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt
  metadata                  Json?
  // Required relationship to User
  userId                    String          @unique
  user                      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum ThemePreference {
  LIGHT
  DARK
  SYSTEM
}

// ===================
// User Profile
// ===================
model UserProfile {
  id          String   @id @default(cuid())
  firstName   String?
  lastName    String?
  displayName String?
  timezone    String   @default("UTC")
  language    String   @default("en")
  avatarUrl   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  metadata    Json?
  // Required relationship to User
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ===================
// Audit Log
// ===================
model AuditLog {
  id             String    @id @default(cuid())
  action         String
  actorType      ActorType @default(ANONYMOUS)
  actorUserId    String?
  targetEntity   String
  targetEntityId String?
  timestamp      DateTime  @default(now())
  ipAddress      String?
  userAgent      String?
  extraContext   Json?
}

enum ActorType {
  USER
  SYSTEM
  ANONYMOUS
}

// ===================
// Tag
// ===================
model Tag {
  id        String    @id @default(cuid())
  name      String // The display name of the tag
  nameLower String    @unique // A lowercase version of the name for case-insensitive uniqueness
  color     String? // Optional color for the tag
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  // Required relationship to User
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  // Many-to-many relationship with Task through TaskTag
  tasks     TaskTag[]

  @@unique([id, userId]) // Ensure tag IDs are unique per user
  @@unique([userId, nameLower]) // Ensure tag names are unique per user, case-insensitively
}

model TaskTag {
  // Composite model for many-to-many relationship between Task and Tag
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId String
  // Composite relationship to Tag   
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagId  String

  @@id([taskId, tagId])
}

// ===================
// Notification
// ===================
model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  message   String
  payload   Json? // Optional JSON payload for additional data related to the notification
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  // Required relationship to User
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum NotificationType {
  EMAIL
  PUSH
  IN_APP
}
